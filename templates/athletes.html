{% extends "base.html" %}

{% block content %}
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/athletes.css') }}">
</head>
<section class="athletes-list">
    <h2>Registered Athletes</h2>
    
    <div class="search-filter">
        <form method="GET" action="{{ url_for('athletes') }}">
            <input type="text" id="search" name="search" placeholder="Search by ID or name..." value="{{ search_query }}">
            <button type="submit">Search</button>
        </form>
    </div>
    
    <div class="athletes-grid">
        {% for athlete in athletes %}
        <div class="athlete-card">
            <div class="athlete-header">
                <h3>{{ athlete.last_name }}</h3>
                <span class="id-badge">ID: {{ athlete.id }}</span>
                <span class="days-badge {% if athlete.days_remaining < 7 %}expiring{% endif %}">
                    {{ athlete.days_remaining }} days left
                </span>
            </div>
            
            <div class="athlete-essential-info">
                <p><strong>Full Name:</strong> {{ athlete.first_name }} {{ athlete.last_name }}</p>
                <p><strong>Phone:</strong> {{ athlete.phone }}</p>
                <p><strong>Registered:</strong> 
                    <span class="gregorian-date" data-date="{{ athlete.registration_date.split(' ')[0] }}">
                        {{ athlete.registration_date.split(' ')[0] }}
                    </span>
                </p>
                <p><strong>End Date:</strong> 
                    <span class="gregorian-date" data-date="{{ athlete.end_date }}">
                        {{ athlete.end_date }}
                    </span>
                </p>
                <p><strong>Period:</strong> {{ athlete.original_days }} days</p>
            </div>
            
            <div class="athlete-actions">
                <a href="{{ url_for('view_athlete', athlete_id=athlete.id) }}" class="action-btn view-btn">
                    <i class="fas fa-eye"></i> View
                </a>
                <a href="{{ url_for('edit_athlete', athlete_id=athlete.id) }}" class="action-btn edit-btn">
                    <i class="fas fa-edit"></i> Edit
                </a>
                <a href="{{ url_for('renew_athlete', athlete_id=athlete.id) }}" class="action-btn renew-btn">
                    <i class="fas fa-sync-alt"></i> Renew
                </a>
                <button type="submit" form="delete-form-{{ athlete.id }}" class="action-btn delete-btn" onclick="return confirm('Are you sure you want to delete this athlete?')">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
                <form id="delete-form-{{ athlete.id }}" action="{{ url_for('delete_athlete', athlete_id=athlete.id) }}" method="POST" class="delete-form"></form>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const cards = document.querySelectorAll('.athlete-card');
                
                cards.forEach(card => {
                    const name = card.querySelector('h3').textContent.toLowerCase();
                    const id = card.querySelector('.id-badge').textContent.toLowerCase();
                    if (name.includes(searchTerm) || id.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        // Date conversion - more robust handling
        document.querySelectorAll('.gregorian-date').forEach(el => {
            const originalDate = el.getAttribute('data-date') || el.textContent.trim();
            
            // Skip conversion if date is empty or invalid
            if (!originalDate || originalDate === 'N/A' || originalDate === 'None') {
                return;
            }

            try {
                // Extract just the date part (YYYY-MM-DD)
                const dateOnly = originalDate.split(' ')[0];
                const convertedDate = gregorianToJalali(dateOnly);
                
                if (convertedDate && convertedDate !== '---') {
                    el.textContent = convertedDate;
                    el.setAttribute('title', "Gregorian: " + originalDate);
                }
            } catch (e) {
                console.error('Date conversion error:', e);
            }
        });
    });
</script>
{% endblock %}