{% extends "base.html" %}

{% block page_title %}Attendance Tracking{% endblock %}
{% block content %}
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/attendance.css') }}">

</head>
<div class="attendance-container">
    <!-- Header Section -->
    <div class="attendance-header">
        <h1 class="attendance-title">
            <i class="fas fa-clipboard-check"></i> Attendance Management
        </h1>
        <div class="header-actions">
            <button class="btn btn-primary" id="exportBtn">
                <i class="fas fa-file-export"></i> Export Report
            </button>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="attendance-filters">
        <form method="get" class="filter-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="date" class="form-label">Select Date</label>
                    <input type="date" name="date" id="date" class="form-control"
                           value="{{ date_filter }}" max="{{ datetime.now().strftime('%Y-%m-%d') }}">
                </div>
                <div class="filter-group">
                    <label for="search" class="form-label">Search Athletes</label>
                    <input type="text" name="search" id="search" class="form-control"
                           placeholder="Name or ID" value="{{ search_query }}">
                </div>
                <div class="filter-group d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Check In/Out Form -->
    <div class="check-form">
        <form method="post" class="check-form-inner">
            <div class="check-controls">
                <div class="athlete-select">
                    <label for="athlete_id" class="form-label">Select Athlete</label>
                    <select name="athlete_id" id="athlete_id" class="form-control" required>
                        <option value="">-- Select an athlete --</option>
                        {% for athlete in active_athletes %}
                        <option value="{{ athlete.id }}">
                            {{ athlete.first_name }} {{ athlete.last_name }} (ID: {{ athlete.id }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="check-buttons">
                    <button type="submit" name="action" value="check_in" class="btn-check btn-check-in">
                        <i class="fas fa-sign-in-alt"></i> Check In
                    </button>
                    <button type="submit" name="action" value="check_out" class="btn-check btn-check-out">
                        <i class="fas fa-sign-out-alt"></i> Check Out
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Attendance Records Table -->
    <div class="table-responsive">
        <table class="attendance-table">
            <thead>
                <tr>
                    <th>Athlete</th>
                    <th>ID</th>
                    <th>Check-In Time</th>
                    <th>Check-Out Time</th>
                    <th>Duration</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% if attendance_records %}
                    {% for record in attendance_records %}
                    <tr {% if not record.check_out_time %}class="current-session"{% endif %}>
                        <td>
                            <strong>{{ record.first_name }} {{ record.last_name }}</strong>
                        </td>
                        <td>{{ record.athlete_id }}</td>
                        <td>
                            {{ record.check_in_time }}
                        </td>
                        <td>
                            {% if record.check_out_time %}
                                {{ record.check_out_time }}
                            {% else %}
                                <span class="badge badge-warning">Active</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.check_out_time %}
                                <span class="duration-badge">
                                    <i class="fas fa-clock"></i> 
                                    {{ record.check_out_time|time_diff(record.check_in_time) }}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.check_out_time %}
                                <span class="badge-present">
                                    <i class="fas fa-check-circle"></i> Completed
                                </span>
                            {% else %}
                                <span class="badge-absent">
                                    <i class="fas fa-running"></i> In Progress
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h3>No attendance records found</h3>
                            <p>No check-ins have been recorded for this date</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Summary Statistics -->
    <div class="stats-summary">
        <div class="stats-card">
            <div class="stats-icon present">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stats-info">
                <h4>{{ present_count or 0 }}</h4>
                <p>Present Today</p>
            </div>
        </div>
        <div class="stats-card">
            <div class="stats-icon active">
                <i class="fas fa-running"></i>
            </div>
            <div class="stats-info">
                <h4>{{ active_sessions or 0 }}</h4>
                <p>Active Sessions</p>
            </div>
        </div>
        <div class="stats-card">
            <div class="stats-icon absent">
                <i class="fas fa-user-slash"></i>
            </div>
            <div class="stats-info">
                <h4>{{ absent_count or 0 }}</h4>
                <p>Absent Today</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default if not set
    if (!document.getElementById('date').value) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
    }
    
    // Export button functionality
    document.getElementById('exportBtn').addEventListener('click', function() {
        const date = document.getElementById('date').value;
        window.location.href = `/export/attendance?date=${date}`;
    });
    
    // Highlight current day in calendar
    const today = new Date().toISOString().split('T')[0];
    if (document.getElementById('date').value === today) {
        const title = document.querySelector('.attendance-title');
        const badge = document.createElement('span');
        badge.className = 'badge-present';
        badge.textContent = 'Today';
        title.appendChild(document.createTextNode(' '));
        title.appendChild(badge);
    }
});
</script>
{% endblock %}